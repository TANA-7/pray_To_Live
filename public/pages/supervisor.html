<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ù† Ø§Ù„Ù…Ø´Ø±Ù | Ø¨Ø§Ù„ØµÙ„Ø§Ø© Ù†Ø­ÙŠØ§</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../styles/style.css" />
    <link rel="stylesheet" href="../styles/layout.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />

    <link rel="icon" type="image/png" href="../media/logo.png" />
    <style>
      body {
        font-family: "Cairo", sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f6f8;
        color: #000814;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
      }

      .container {
        width: 90%;
        max-width: 800px;
        background-color: #fff;
        margin-top: 50px;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      h2 {
        text-align: center;
        color: #001d3d;
      }

      .user-list {
        margin-bottom: 20px;
      }

      .user-list table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
      }

      .user-list table th,
      .user-list table td {
        padding: 10px;
        text-align: center;
        border: 1px solid #ccc;
      }

      .user-list table th {
        background-color: #003566;
        color: white;
      }

      .user-status {
        color: #28a745;
      }

      .user-status.off {
        color: #dc3545;
      }

      .feedback {
        margin-top: 20px;
      }

      .feedback textarea {
        width: 100%;
        height: 100px;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
      }

      .feedback button {
        width: 100%;
        padding: 12px;
        font-size: 16px;
        border: none;
        border-radius: 8px;
        background-color: #003566;
        color: white;
        cursor: pointer;
        margin-top: 10px;
      }

      .feedback button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      .table-container {
        overflow-x: auto;
        margin-bottom: 20px;
      }

      .table-custom {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        background-color: #fff;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      }

      .table-custom thead {
        background-color: #003566;
        color: white;
        text-align: center;
      }

      .table-custom th,
      .table-custom td {
        padding: 12px 16px;
        border-bottom: 1px solid #eee;
        font-size: 0.95rem;
      }

      .table-custom tbody tr:hover {
        background-color: #f1f7ff;
      }

      .table-custom td:last-child,
      .table-custom th:last-child {
        text-align: center;
      }
      .notify-modal {
        position: fixed;
        top: 0;
        right: 0;
        left: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
      .notify-content {
        background: white;
        padding: 2rem;
        border-radius: 10px;
        width: 90%;
        max-width: 500px;
        text-align: right;
        direction: rtl;
      }
      .notify-content h3 {
        margin-bottom: 1rem;
      }
      .notify-content input,
      .notify-content textarea {
        width: 100%;
        padding: 10px;
        margin-bottom: 1rem;
        border-radius: 8px;
        border: 1px solid #ccc;
      }
      .notify-actions {
        display: flex;
        justify-content: space-between;
      }
      .btn-notify {
        background-color: #003566;
        color: white;
        padding: 6px 10px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }
.hidden {
  display: none !important;
}

      @media (max-width: 600px) {
        .table-custom th,
        .table-custom td {
          padding: 10px;
          font-size: 0.85rem;
        }
      }
    </style>
  </head>
  <body>
    <header class="layout-header" dir="rtl">
      <div class="layout-container">
        <div class="layout-logo">
          <img src="../media/logo.png" alt="Logo" />
          <p>Ø¨Ø§Ù„ØµÙ„Ø§Ø© Ù†Ø­ÙŠØ§</p>
        </div>
        <nav class="layout-nav">
          <ul>
            <li class="btns-li">
              <i
                class="fa-solid fa-circle-user"
                onclick="window.open('profile.html','_parent')"
              ></i>
            </li>

            <button id="logoutBtn" class="btn-primary">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
          </ul>
        </nav>
        <div class="layout-list-icon">
          <i
            class="fa-solid fa-circle-user"
            onclick="window.open('profile.html','_parent')"
          ></i>
          <i class="fa-solid fa-bars" onclick="toggleSidebar()"></i>
        </div>
      </div>
    </header>
    <aside class="layout-sidebar" id="layoutSidebar">
      <ul>
        <li><a href="#" id="logoutBtnSide">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a></li>
      </ul>
    </aside>
    <div class="container fadeIn">
      <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ù† Ø§Ù„Ù…Ø´Ø±Ù</h2>

      <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ù„Ù…Ø´Ø±Ù -->
      <div class="user-list">
        <div class="table-container">
          <table class="table-custom">
            <thead>
              <tr>
                <th>Ø§Ù„Ø§Ø³Ù…</th>
                <th>Ø­Ø§Ù„Ø© Ø§Ù„ØµÙ„Ø§Ø©</th>
                <th>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØµÙ„Ø§Ø©</th>
                <th>Ø¥Ø´Ø¹Ø§Ø±</th>
                <th>Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</th>
                <!-- ğŸ†• -->
              </tr>
            </thead>

            <tbody>
              <!-- Ø§Ù„ØµÙÙˆÙ ØªÙØ­Ù‚Ù† Ù…Ù† JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div id="notifyModal" class="notify-modal" style="display: none">
      <div class="notify-content">
        <h3>Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>
        <input type="text" id="notifyTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±" />
        <textarea
          id="notifyMessage"
          placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù‡Ù†Ø§..."
        ></textarea>
        <div class="notify-actions">
          <button onclick="sendNotification()">Ø¥Ø±Ø³Ø§Ù„</button>
          <button onclick="closeNotifyModal()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </div>
    </div>
<div id="userNotifModal" class="notify-modal hidden">
  <div class="notify-content">
    <h3 id="notifUserName">Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>
    <div id="userNotifList"></div>
    <button onclick="closeUserNotifModal()" class="btn-notify" style="margin-top: 15px;">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
</div>

<!-- âœ… Ù‚Ø³Ù… ÙØªØ§ÙˆÙ‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
<div class="fatwa-panel">
  <h3>Ø§Ù„ÙØªØ§ÙˆÙ‰ Ø§Ù„Ù…Ø±Ø³Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
  <div id="fatwaList"></div>
</div>

<!-- âœ… Modal Ù„Ù„Ø±Ø¯ -->
<div id="fatwaModal" class="notify-modal hidden">
  <div class="notify-content">
    <h3 id="fatwaModalQuestion">Ø§Ù„Ø³Ø¤Ø§Ù„</h3>
    <textarea id="fatwaAnswerText" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø¯ Ù‡Ù†Ø§..."></textarea>
    <div class="notify-actions">
      <button onclick="submitFatwaAnswer()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯</button>
      <button onclick="closeFatwaModal()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

    <div id="notifyBox" class="notify hidden"></div>

    <script>
      const token = localStorage.getItem("token");

      if (!token) {
        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        window.location.href = "login.html"; // Ø£Ùˆ login.html Ø­Ø³Ø¨ Ø§Ø³Ù… Ø§Ù„ØµÙØ­Ø© Ø¹Ù†Ø¯Ùƒ
      }
      let selectedFatwaId = null;

// âœ… Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„ÙØªØ§ÙˆÙ‰ Ø§Ù„Ù…Ø³Ù†Ø¯Ø© Ù„Ù„Ù…Ø´Ø±Ù (Ù‡Ùˆ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù†Ù‡Ø§)
async function fetchAssignedFatwas() {
  const token = localStorage.getItem("token");
  const supervisorId = localStorage.getItem("userId"); // ÙØ±Ø¶Ø§Ù‹ Ø¹Ù†Ø¯Ùƒ userId Ù…Ø­ÙÙˆØ¸ âœ…

  try {
    const res = await fetch(`http://localhost:5000/api/fatwa/assigned/${supervisorId}`, {
      headers: { Authorization: `Bearer ${token}` },
    });
    const fatwas = await res.json();

    const fatwaList = document.getElementById("fatwaList");
    fatwaList.innerHTML = "";

    fatwas.forEach((fatwa) => {
      const box = document.createElement("div");
      box.style.border = "1px solid #ddd";
      box.style.borderRadius = "8px";
      box.style.padding = "10px";
      box.style.marginBottom = "10px";
      box.style.background = "#fff";

      box.innerHTML = `
        <p><strong>Ø§Ù„Ø³Ø¤Ø§Ù„:</strong> ${fatwa.question}</p>
        <p><strong>Ø§Ù„Ø±Ø¯:</strong> ${
          fatwa.answer && fatwa.answer.text ? fatwa.answer.text : '<em style="color:#999">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø±Ø¯ Ø¨Ø¹Ø¯</em>'
        }</p>
        <p><small>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ${new Date(fatwa.createdAt).toLocaleString()}</small></p>
        ${
          fatwa.answer && fatwa.answer.text
            ? "" // Ø¥Ø°Ø§ ÙÙŠÙ‡ Ø±Ø¯ØŒ Ù„Ø§ ØªØ¸Ù‡Ø± Ø²Ø± Ø§Ù„Ø±Ø¯
            : `<button class="btn-notify" onclick="openFatwaModal('${fatwa._id}', \`${fatwa.question}\`)">âœï¸ Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ÙØªÙˆÙ‰</button>`
        }
      `;

      fatwaList.appendChild(box);
    });
  } catch (err) {
    console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ÙØªØ§ÙˆÙ‰:", err);
    showNotification("ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØªØ§ÙˆÙ‰", true);
  }
}

// âœ… ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø±Ø¯
function openFatwaModal(fatwaId, question) {
  selectedFatwaId = fatwaId;
  document.getElementById("fatwaModalQuestion").innerText = question;
  document.getElementById("fatwaAnswerText").value = "";
  document.getElementById("fatwaModal").classList.remove("hidden");
}

// âœ… Ø¥ØºÙ„Ø§Ù‚ Ù…ÙˆØ¯Ø§Ù„
function closeFatwaModal() {
  document.getElementById("fatwaModal").classList.add("hidden");
}

// âœ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯
async function submitFatwaAnswer() {
  const token = localStorage.getItem("token");
  const answerText = document.getElementById("fatwaAnswerText").value.trim();

  if (!answerText) {
    showNotification("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø±Ø¯ Ø£ÙˆÙ„Ø§Ù‹", true);
    return;
  }

  try {
    const res = await fetch(`http://localhost:5000/api/fatwa/answer/${selectedFatwaId}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`,
      },
      body: JSON.stringify({ text: answerText }), // Ø§Ø³ØªØ®Ø¯Ù…Ù†Ø§ answer.text ÙÙŠ Ø§Ù„Ù€ schema Ø§Ù„Ø¬Ø¯ÙŠØ¯
    });

    const data = await res.json();
    if (res.ok) {
      showNotification("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ÙØªÙˆÙ‰");
      closeFatwaModal();
      fetchAssignedFatwas(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    } else {
      showNotification(data.message || "âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯", true);
    }
  } catch (err) {
    console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯:", err);
    showNotification("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯", true);
  }
}

      const tableBody = document.querySelector(".user-list tbody");

      async function fetchUsers() {
        const token = localStorage.getItem("token");
        if (!token) return showNotification("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø´Ø±Ù.", true);

        try {
          const res = await fetch("http://localhost:5000/api/users/my-users", {
            headers: { Authorization: "Bearer " + token },
          });
          const users = await res.json();

          tableBody.innerHTML = "";
          for (const user of users) {
            const count = await fetchPrayerCount(user._id);
            const status =
              user.prayerStatus || (count >= 5 ? "Ù…Ø­Ø§ÙØ¸" : "ØºÙŠØ± Ù…Ø­Ø§ÙØ¸");
            const statusClass =
              status === "Ù…Ø­Ø§ÙØ¸" ? "user-status" : "user-status off";

            const row = document.createElement("tr");
            row.innerHTML = `
  <td>${user.username} ${user.fatherName || ""} ${user.lastName || ""}</td>
  <td class="${statusClass}">${status}</td>
  <td>${count} ØµÙ„ÙˆØ§Øª</td>
  <td><button class="btn-notify" onclick="openNotificationForm('${
    user._id
  }')">âœ‰ï¸</button></td>
  <td><button onclick="showUserNotifications('${
    user._id
  }')">ğŸ“¬ Ø¥Ø´Ø¹Ø§Ø±Ø§ØªÙ‡</button></td>

`;

            tableBody.appendChild(row);
          }
        } catch (err) {
          console.error("ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:", err);
          showNotification("ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†", true);
        }
      }

      async function fetchPrayerCount(userId) {
        const token = localStorage.getItem("token");
        try {
          const res = await fetch(
            `http://localhost:5000/api/prayers/count/${userId}`,
            {
              headers: {
                Authorization: "Bearer " + token,
              },
            }
          );
          const data = await res.json();
          return data.count || 0;
        } catch (err) {
          console.error("ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„ØµÙ„ÙˆØ§Øª:", err);
          return 0;
        }
      }
      window.toggleSidebar = () => {
        document.getElementById("layoutSidebar").classList.toggle("active");
      };
      function logout() {
        localStorage.removeItem("token");
        localStorage.removeItem("user");
        localStorage.removeItem("userName");
        localStorage.removeItem("userEmail");
        window.location.href = "login.html";
      }
      document.getElementById("logoutBtn").addEventListener("click", logout);
      document
        .getElementById("logoutBtnSide")
        .addEventListener("click", logout);
      let selectedUserId = null;

      function openNotificationForm(userId) {
        selectedUserId = userId;
        document.getElementById("notifyModal").style.display = "flex";
      }

      function closeNotifyModal() {
        document.getElementById("notifyModal").style.display = "none";
        document.getElementById("notifyTitle").value = "";
        document.getElementById("notifyMessage").value = "";
      }

      async function sendNotification() {
        const token = localStorage.getItem("token");
        const title = document.getElementById("notifyTitle").value.trim();
        const message = document.getElementById("notifyMessage").value.trim();

        if (!title || !message) {
          return showNotification("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ø±Ø³Ø§Ù„Ø©.", true);
        }

        try {
          const res = await fetch("http://localhost:5000/api/notifications", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + token,
            },
            body: JSON.stringify({
              userId: selectedUserId,
              title,
              message,
            }),
          });

          const data = await res.json();
          if (res.ok) {
            showNotification("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±");
            closeNotifyModal();
          } else {
            showNotification(data.message || "âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„", true);
          }
        } catch (err) {
          console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±:", err);
          showNotification("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±", true);
        }
      }

      function showNotification(message, isError = false) {
        const box = document.getElementById("notifyBox");
        box.innerText = message;
        box.className = "notify" + (isError ? " error" : "");
        setTimeout(() => box.classList.remove("hidden"), 10);
        setTimeout(() => box.classList.add("hidden"), 3000);
      }
    async function showUserNotifications(userId) {
  const token = localStorage.getItem("token");
  try {
    const res = await fetch(
      `http://localhost:5000/api/notifications/user/${userId}`,
      {
        headers: { Authorization: `Bearer ${token}` },
      }
    );
    const data = await res.json();

    if (res.ok) {
      const list = document.getElementById("userNotifList");
      list.innerHTML = "";

      data.notifications.forEach((notif) => {
        const box = document.createElement("div");
        box.style.border = "1px solid #ddd";
        box.style.borderRadius = "8px";
        box.style.padding = "10px";
        box.style.marginBottom = "10px";
        box.style.background = "#fff";

        box.innerHTML = `
          <strong>${notif.title}</strong>
          <p>${notif.message}</p>
          <p><em>Ø£ÙØ±Ø³Ù„Øª ÙÙŠ: ${new Date(notif.createdAt).toLocaleString()}</em></p>
          ${
            notif.reply
              ? `<div style="background:#f9f9f9; padding:10px; border-radius:6px; margin-top:10px">
                    <strong>Ø±Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</strong>
                    <p>${notif.reply.text}</p>
                    <small>${new Date(notif.reply.date).toLocaleString()}</small>
                </div>`
              : `<em style="color:#999">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø¯</em>`
          }
        `;
        list.appendChild(box);
      });

      // Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
      document.getElementById("userNotifModal").classList.remove("hidden");
    }
  } catch (err) {
    console.error("ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", err);
    showNotification("ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", true);
  }
}


function closeUserNotifModal() {
  document.getElementById("userNotifModal").classList.add("hidden");
}


      window.onload = () => {
        fetchUsers();
          fetchAssignedFatwas(); // âœ… ØªØ­Ù…ÙŠÙ„ ÙØªØ§ÙˆÙ‰ Ø§Ù„Ù…Ø´Ø±Ù
        
      };
    </script>
  </body>
</html>
