<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>لوحة المتابعة من المشرف | بالصلاة نحيا</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../styles/style.css" />
    <link rel="stylesheet" href="../styles/layout.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />

    <link rel="icon" type="image/png" href="../media/logo.png" />
    <style>
      body {
        font-family: "Cairo", sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f6f8;
        color: #000814;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
      }

      .container {
        width: 90%;
        max-width: 800px;
        background-color: #fff;
        margin-top: 50px;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      h2 {
        text-align: center;
        color: #001d3d;
      }

      .user-list {
        margin-bottom: 20px;
      }

      .user-list table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
      }

      .user-list table th,
      .user-list table td {
        padding: 10px;
        text-align: center;
        border: 1px solid #ccc;
      }

      .user-list table th {
        background-color: #003566;
        color: white;
      }

      .user-status {
        color: #28a745;
      }

      .user-status.off {
        color: #dc3545;
      }

      .feedback {
        margin-top: 20px;
      }

      .feedback textarea {
        width: 100%;
        height: 100px;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
      }

      .feedback button {
        width: 100%;
        padding: 12px;
        font-size: 16px;
        border: none;
        border-radius: 8px;
        background-color: #003566;
        color: white;
        cursor: pointer;
        margin-top: 10px;
      }

      .feedback button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      .table-container {
        overflow-x: auto;
        margin-bottom: 20px;
      }

      .table-custom {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        background-color: #fff;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      }

      .table-custom thead {
        background-color: #003566;
        color: white;
        text-align: center;
      }

      .table-custom th,
      .table-custom td {
        padding: 12px 16px;
        border-bottom: 1px solid #eee;
        font-size: 0.95rem;
      }

      .table-custom tbody tr:hover {
        background-color: #f1f7ff;
      }

      .table-custom td:last-child,
      .table-custom th:last-child {
        text-align: center;
      }
      .notify-modal {
        position: fixed;
        top: 0;
        right: 0;
        left: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
      .notify-content {
        background: white;
        padding: 2rem;
        border-radius: 10px;
        width: 90%;
        max-width: 500px;
        text-align: right;
        direction: rtl;
      }
      .notify-content h3 {
        margin-bottom: 1rem;
      }
      .notify-content input,
      .notify-content textarea {
        width: 100%;
        padding: 10px;
        margin-bottom: 1rem;
        border-radius: 8px;
        border: 1px solid #ccc;
      }
      .notify-actions {
        display: flex;
        justify-content: space-between;
      }
      .btn-notify {
        background-color: #003566;
        color: white;
        padding: 6px 10px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }
.hidden {
  display: none !important;
}

      @media (max-width: 600px) {
        .table-custom th,
        .table-custom td {
          padding: 10px;
          font-size: 0.85rem;
        }
      }
    </style>
  </head>
  <body>
    <header class="layout-header" dir="rtl">
      <div class="layout-container">
        <div class="layout-logo">
          <img src="../media/logo.png" alt="Logo" />
          <p>بالصلاة نحيا</p>
        </div>
        <nav class="layout-nav">
          <ul>
            <li class="btns-li">
              <i
                class="fa-solid fa-circle-user"
                onclick="window.open('profile.html','_parent')"
              ></i>
            </li>

            <button id="logoutBtn" class="btn-primary">تسجيل الخروج</button>
          </ul>
        </nav>
        <div class="layout-list-icon">
          <i
            class="fa-solid fa-circle-user"
            onclick="window.open('profile.html','_parent')"
          ></i>
          <i class="fa-solid fa-bars" onclick="toggleSidebar()"></i>
        </div>
      </div>
    </header>
    <aside class="layout-sidebar" id="layoutSidebar">
      <ul>
        <li><a href="#" id="logoutBtnSide">تسجيل الخروج</a></li>
      </ul>
    </aside>
    <div class="container fadeIn">
      <h2>لوحة المتابعة من المشرف</h2>

      <!-- قائمة المستخدمين للمشرف -->
      <div class="user-list">
        <div class="table-container">
          <table class="table-custom">
            <thead>
              <tr>
                <th>الاسم</th>
                <th>حالة الصلاة</th>
                <th>إحصائيات الصلاة</th>
                <th>إشعار</th>
                <th>عرض الإشعارات</th>
                <!-- 🆕 -->
              </tr>
            </thead>

            <tbody>
              <!-- الصفوف تُحقن من JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div id="notifyModal" class="notify-modal" style="display: none">
      <div class="notify-content">
        <h3>إرسال إشعار للمستخدم</h3>
        <input type="text" id="notifyTitle" placeholder="عنوان الإشعار" />
        <textarea
          id="notifyMessage"
          placeholder="اكتب الرسالة هنا..."
        ></textarea>
        <div class="notify-actions">
          <button onclick="sendNotification()">إرسال</button>
          <button onclick="closeNotifyModal()">إلغاء</button>
        </div>
      </div>
    </div>
<div id="userNotifModal" class="notify-modal hidden">
  <div class="notify-content">
    <h3 id="notifUserName">إشعارات المستخدم</h3>
    <div id="userNotifList"></div>
    <button onclick="closeUserNotifModal()" class="btn-notify" style="margin-top: 15px;">إغلاق</button>
  </div>
</div>

<!-- ✅ قسم فتاوى المستخدمين -->
<div class="fatwa-panel">
  <h3>الفتاوى المرسلة من المستخدمين</h3>
  <div id="fatwaList"></div>
</div>

<!-- ✅ Modal للرد -->
<div id="fatwaModal" class="notify-modal hidden">
  <div class="notify-content">
    <h3 id="fatwaModalQuestion">السؤال</h3>
    <textarea id="fatwaAnswerText" placeholder="اكتب الرد هنا..."></textarea>
    <div class="notify-actions">
      <button onclick="submitFatwaAnswer()">إرسال الرد</button>
      <button onclick="closeFatwaModal()">إلغاء</button>
    </div>
  </div>
</div>

    <div id="notifyBox" class="notify hidden"></div>

    <script>
      const token = localStorage.getItem("token");

      if (!token) {
        // إعادة توجيه لصفحة تسجيل الدخول
        window.location.href = "login.html"; // أو login.html حسب اسم الصفحة عندك
      }
      let selectedFatwaId = null;

// ✅ جلب كل الفتاوى المسندة للمشرف (هو المسؤول عنها)
async function fetchAssignedFatwas() {
  const token = localStorage.getItem("token");
  const supervisorId = localStorage.getItem("userId"); // فرضاً عندك userId محفوظ ✅

  try {
    const res = await fetch(`http://localhost:5000/api/fatwa/assigned/${supervisorId}`, {
      headers: { Authorization: `Bearer ${token}` },
    });
    const fatwas = await res.json();

    const fatwaList = document.getElementById("fatwaList");
    fatwaList.innerHTML = "";

    fatwas.forEach((fatwa) => {
      const box = document.createElement("div");
      box.style.border = "1px solid #ddd";
      box.style.borderRadius = "8px";
      box.style.padding = "10px";
      box.style.marginBottom = "10px";
      box.style.background = "#fff";

      box.innerHTML = `
        <p><strong>السؤال:</strong> ${fatwa.question}</p>
        <p><strong>الرد:</strong> ${
          fatwa.answer && fatwa.answer.text ? fatwa.answer.text : '<em style="color:#999">لم يتم الرد بعد</em>'
        }</p>
        <p><small>تاريخ الإرسال: ${new Date(fatwa.createdAt).toLocaleString()}</small></p>
        ${
          fatwa.answer && fatwa.answer.text
            ? "" // إذا فيه رد، لا تظهر زر الرد
            : `<button class="btn-notify" onclick="openFatwaModal('${fatwa._id}', \`${fatwa.question}\`)">✏️ رد على الفتوى</button>`
        }
      `;

      fatwaList.appendChild(box);
    });
  } catch (err) {
    console.error("خطأ في جلب الفتاوى:", err);
    showNotification("فشل في تحميل الفتاوى", true);
  }
}

// ✅ فتح مودال الرد
function openFatwaModal(fatwaId, question) {
  selectedFatwaId = fatwaId;
  document.getElementById("fatwaModalQuestion").innerText = question;
  document.getElementById("fatwaAnswerText").value = "";
  document.getElementById("fatwaModal").classList.remove("hidden");
}

// ✅ إغلاق مودال
function closeFatwaModal() {
  document.getElementById("fatwaModal").classList.add("hidden");
}

// ✅ إرسال الرد
async function submitFatwaAnswer() {
  const token = localStorage.getItem("token");
  const answerText = document.getElementById("fatwaAnswerText").value.trim();

  if (!answerText) {
    showNotification("يرجى كتابة الرد أولاً", true);
    return;
  }

  try {
    const res = await fetch(`http://localhost:5000/api/fatwa/answer/${selectedFatwaId}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`,
      },
      body: JSON.stringify({ text: answerText }), // استخدمنا answer.text في الـ schema الجديد
    });

    const data = await res.json();
    if (res.ok) {
      showNotification("✅ تم إرسال الرد على الفتوى");
      closeFatwaModal();
      fetchAssignedFatwas(); // تحديث القائمة
    } else {
      showNotification(data.message || "❌ فشل في إرسال الرد", true);
    }
  } catch (err) {
    console.error("خطأ في إرسال الرد:", err);
    showNotification("❌ حدث خطأ أثناء إرسال الرد", true);
  }
}

      const tableBody = document.querySelector(".user-list tbody");

      async function fetchUsers() {
        const token = localStorage.getItem("token");
        if (!token) return showNotification("يرجى تسجيل الدخول كمشرف.", true);

        try {
          const res = await fetch("http://localhost:5000/api/users/my-users", {
            headers: { Authorization: "Bearer " + token },
          });
          const users = await res.json();

          tableBody.innerHTML = "";
          for (const user of users) {
            const count = await fetchPrayerCount(user._id);
            const status =
              user.prayerStatus || (count >= 5 ? "محافظ" : "غير محافظ");
            const statusClass =
              status === "محافظ" ? "user-status" : "user-status off";

            const row = document.createElement("tr");
            row.innerHTML = `
  <td>${user.username} ${user.fatherName || ""} ${user.lastName || ""}</td>
  <td class="${statusClass}">${status}</td>
  <td>${count} صلوات</td>
  <td><button class="btn-notify" onclick="openNotificationForm('${
    user._id
  }')">✉️</button></td>
  <td><button onclick="showUserNotifications('${
    user._id
  }')">📬 إشعاراته</button></td>

`;

            tableBody.appendChild(row);
          }
        } catch (err) {
          console.error("فشل في جلب المستخدمين:", err);
          showNotification("فشل في تحميل المستخدمين", true);
        }
      }

      async function fetchPrayerCount(userId) {
        const token = localStorage.getItem("token");
        try {
          const res = await fetch(
            `http://localhost:5000/api/prayers/count/${userId}`,
            {
              headers: {
                Authorization: "Bearer " + token,
              },
            }
          );
          const data = await res.json();
          return data.count || 0;
        } catch (err) {
          console.error("فشل في جلب عدد الصلوات:", err);
          return 0;
        }
      }
      window.toggleSidebar = () => {
        document.getElementById("layoutSidebar").classList.toggle("active");
      };
      function logout() {
        localStorage.removeItem("token");
        localStorage.removeItem("user");
        localStorage.removeItem("userName");
        localStorage.removeItem("userEmail");
        window.location.href = "login.html";
      }
      document.getElementById("logoutBtn").addEventListener("click", logout);
      document
        .getElementById("logoutBtnSide")
        .addEventListener("click", logout);
      let selectedUserId = null;

      function openNotificationForm(userId) {
        selectedUserId = userId;
        document.getElementById("notifyModal").style.display = "flex";
      }

      function closeNotifyModal() {
        document.getElementById("notifyModal").style.display = "none";
        document.getElementById("notifyTitle").value = "";
        document.getElementById("notifyMessage").value = "";
      }

      async function sendNotification() {
        const token = localStorage.getItem("token");
        const title = document.getElementById("notifyTitle").value.trim();
        const message = document.getElementById("notifyMessage").value.trim();

        if (!title || !message) {
          return showNotification("الرجاء كتابة العنوان والرسالة.", true);
        }

        try {
          const res = await fetch("http://localhost:5000/api/notifications", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + token,
            },
            body: JSON.stringify({
              userId: selectedUserId,
              title,
              message,
            }),
          });

          const data = await res.json();
          if (res.ok) {
            showNotification("✅ تم إرسال الإشعار");
            closeNotifyModal();
          } else {
            showNotification(data.message || "❌ فشل في الإرسال", true);
          }
        } catch (err) {
          console.error("خطأ في إرسال الإشعار:", err);
          showNotification("❌ حدث خطأ أثناء إرسال الإشعار", true);
        }
      }

      function showNotification(message, isError = false) {
        const box = document.getElementById("notifyBox");
        box.innerText = message;
        box.className = "notify" + (isError ? " error" : "");
        setTimeout(() => box.classList.remove("hidden"), 10);
        setTimeout(() => box.classList.add("hidden"), 3000);
      }
    async function showUserNotifications(userId) {
  const token = localStorage.getItem("token");
  try {
    const res = await fetch(
      `http://localhost:5000/api/notifications/user/${userId}`,
      {
        headers: { Authorization: `Bearer ${token}` },
      }
    );
    const data = await res.json();

    if (res.ok) {
      const list = document.getElementById("userNotifList");
      list.innerHTML = "";

      data.notifications.forEach((notif) => {
        const box = document.createElement("div");
        box.style.border = "1px solid #ddd";
        box.style.borderRadius = "8px";
        box.style.padding = "10px";
        box.style.marginBottom = "10px";
        box.style.background = "#fff";

        box.innerHTML = `
          <strong>${notif.title}</strong>
          <p>${notif.message}</p>
          <p><em>أُرسلت في: ${new Date(notif.createdAt).toLocaleString()}</em></p>
          ${
            notif.reply
              ? `<div style="background:#f9f9f9; padding:10px; border-radius:6px; margin-top:10px">
                    <strong>رد المستخدم:</strong>
                    <p>${notif.reply.text}</p>
                    <small>${new Date(notif.reply.date).toLocaleString()}</small>
                </div>`
              : `<em style="color:#999">لا يوجد رد</em>`
          }
        `;
        list.appendChild(box);
      });

      // عرض النافذة المنبثقة
      document.getElementById("userNotifModal").classList.remove("hidden");
    }
  } catch (err) {
    console.error("فشل في جلب إشعارات المستخدم:", err);
    showNotification("فشل في تحميل إشعارات المستخدم", true);
  }
}


function closeUserNotifModal() {
  document.getElementById("userNotifModal").classList.add("hidden");
}


      window.onload = () => {
        fetchUsers();
          fetchAssignedFatwas(); // ✅ تحميل فتاوى المشرف
        
      };
    </script>
  </body>
</html>
